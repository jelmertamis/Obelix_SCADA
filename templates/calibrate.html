<!DOCTYPE html>
<html>
<head>
  <title>Kalibratie Interface</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.min.js"></script>
</head>
<body>
  <h1>Kalibratie per Kanaal</h1>
  <div id="controls"></div>

  <script>
    const socket = io('/cal');
    socket.on('init_cal', calData => {
      const units = {{ units|tojson }};
      const cont = document.getElementById('controls');
      units.forEach((u,i) => {
        if (u.type==='analog') {
          for (let ch=0; ch<4; ch++) {
            const key = `${i}-${ch}`;
            const cal = calData[key]||{scale:1, offset:0};
            const div = document.createElement('div');
            div.innerHTML = `
              <h3>${u.name} (ID ${u.slave_id}), kanaal ${ch}</h3>
              <p>Raw: <span id="raw-${key}">?</span></p>
              Scale: <input id="scale-${key}" type="number" step="0.0001" value="${cal.scale}">
              Offset: <input id="offset-${key}" type="number" step="0.01" value="${cal.offset}">
              <button onclick="saveCal(${i},${ch})">Opslaan</button>
              <hr>`;
            cont.appendChild(div);
            socket.emit('get_raw',{unit_index:i,channel:ch});
          }
        }
      });
    });

    socket.on('raw_value', d => {
      const el = document.getElementById(`raw-${d.unit}-${d.channel}`);
      el.textContent = d.raw !== null ? d.raw : 'Err';
    });

    function saveCal(u,ch){
      const key = `${u}-${ch}`;
      const scale = parseFloat(document.getElementById(`scale-${key}`).value);
      const offset= parseFloat(document.getElementById(`offset-${key}`).value);
      socket.emit('set_cal',{unit:u,channel:ch,scale,offset});
      alert(`Kalibratie opgeslagen voor unit ${u}, kanaal ${ch}`);
    }
  </script>
</body>
</html>
