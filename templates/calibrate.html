<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sensor Range Instellingen</title>
  <style>
    body { font-family: sans-serif; padding:1rem; }
    h1 { text-align:center; margin-bottom:1rem; }
    table { border-collapse: collapse; width: 90%; margin: auto; }
    th, td { border:1px solid #ccc; padding:0.5rem; text-align: center; }
    th { background: #f0f0f0; }
    input[type=number] { width:4em; }
    button {
      padding:0.3rem 0.6rem;
      margin:0;
      font-size:0.9rem;
      border:none;
      border-radius:4px;
      background:#007bff;
      color:white;
      cursor:pointer;
    }
    button:hover { background:#0056b3; }
    .status { color:green; font-size:0.9rem; }
    .error  { color:red;   font-size:0.9rem; }
  </style>
</head>
<body>
  <h1>Sensor Range Instellingen</h1>
  <p style="text-align:center;"><a href="{{ url_for('index') }}">← Terug naar Dashboard</a></p>

  <table>
    <thead>
      <tr>
        <th>Module</th>
        <th>Slave ID</th>
        <th>Kanaal</th>
        <th>Min waarde</th>
        <th>Max waarde</th>
        <th>Slope</th>
        <th>Offset</th>
        <th>Actie</th>
        <th>Feedback</th>
      </tr>
    </thead>
    <tbody>
      {% for i in range(units|length) %}
        {% if units[i]['type']=='analog' %}
        {% for ch in range(4) %}
        <tr data-unit="{{ i }}" data-channel="{{ ch }}">
          <td>{{ units[i]['name'] }}</td>
          <td>{{ units[i]['slave_id'] }}</td>
          <td>{{ ch }}</td>
          <td>
            <input type="number" step="0.1" class="minVal" placeholder="bv. 0.0">
          </td>
          <td>
            <input type="number" step="0.1" class="maxVal" placeholder="bv. 120.0">
          </td>
          <td class="slope">—</td>
          <td class="offset">—</td>
          <td><button class="saveBtn">Opslaan</button></td>
          <td class="feedback"></td>
        </tr>
        {% endfor %}
        {% endif %}
      {% endfor %}
    </tbody>
  </table>

  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <script>
    const socket = io('/cal');

    // Als de pagina laadt: init_cal met bestaande cal-waarden
    socket.on('init_cal', data => {
      // data heeft keys als "unit-channel": {scale,offset}
      document.querySelectorAll('tbody tr').forEach(row => {
        const u = row.getAttribute('data-unit'),
              c = row.getAttribute('data-channel'),
              key = `${u}-${c}`;
        if (data[key]) {
          row.querySelector('.slope').textContent  = data[key].scale.toFixed(4);
          row.querySelector('.offset').textContent = data[key].offset.toFixed(2);
        }
      });
    });

    // Na opslaan: update één rij
    socket.on('cal_saved', info => {
      const sel = `tr[data-unit="${info.unit}"][data-channel="${info.channel}"]`;
      const row = document.querySelector(sel);
      row.querySelector('.slope').textContent    = info.scale.toFixed(4);
      row.querySelector('.offset').textContent   = info.offset.toFixed(2);
      const fb = row.querySelector('.feedback');
      fb.textContent      = '✔︎ Opslaan gelukt';
      fb.className        = 'feedback status';
      setTimeout(() => fb.textContent = '', 3000);
    });

    socket.on('cal_error', err => {
      // We vinden welke rij het was aan de hand van err heeft geen unit/channel
      // Dus simpelweg tonen onder de hele tabel:
      alert('Kalibratie fout: ' + err.error);
    });

    // Button-handler per rij
    document.querySelectorAll('.saveBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const row     = btn.closest('tr');
        const unit    = +row.getAttribute('data-unit');
        const channel = +row.getAttribute('data-channel');
        const phys1   = parseFloat(row.querySelector('.minVal').value);
        const phys2   = parseFloat(row.querySelector('.maxVal').value);
        if (isNaN(phys1) || isNaN(phys2)) {
          row.querySelector('.feedback').textContent = 'Vul beide waarden in';
          row.querySelector('.feedback').className = 'feedback error';
          return;
        }
        // vaststaande raw-waarden voor 4mA→20mA
        socket.emit('set_cal_points', {
          unit:    unit,
          channel: channel,
          raw1:    819,
          phys1:   phys1,
          raw2:    4095,
          phys2:   phys2
        });
      });
    });

    // Vraag init_cal aan zodra verbonden
    socket.emit('init_cal');
  </script>
</body>
</html>
