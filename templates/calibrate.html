<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sensor Range Instellingen</title>
  <style>
    body { font-family: sans-serif; padding:1rem; text-align:center; }
    h1 { margin-bottom:1rem; }
    .form-group { margin:0.5rem 0; }
    label { display:block; margin-bottom:0.25rem; }
    select, input, button {
      font-size:1rem; padding:0.4rem; width:200px; margin-bottom:0.5rem;
    }
    button { width:auto; }
    .status { color:green; margin-top:1rem; }
    .error  { color:red; margin-top:1rem; }
  </style>
</head>
<body>
  <h1>Sensor Range Instellingen</h1>
  <p><a href="{{ url_for('index') }}">← Terug naar Dashboard</a></p>

  <div class="form-group">
    <label>Module:</label>
    <select id="unitSelect">
      {% for i in range(units|length) %}
        {% if units[i]['type']=='analog' %}
          <option value="{{ i }}">
            {{ units[i]['name'] }} (ID {{ units[i]['slave_id'] }})
          </option>
        {% endif %}
      {% endfor %}
    </select>
  </div>

  <div class="form-group">
    <label>Kanaal:</label>
    <select id="channelSelect">
      {% for ch in range(4) %}
        <option value="{{ ch }}">Kanaal {{ ch }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group">
    <label>Min sensorwaarde (raw=0):</label>
    <input type="number" step="0.1" id="minValue" placeholder="bijv. 0.0">
  </div>

  <div class="form-group">
    <label>Max sensorwaarde (raw=4095):</label>
    <input type="number" step="0.1" id="maxValue" placeholder="bijv. 120.0">
  </div>

  <button id="saveRange">Opslaan Range</button>

  <div id="statusMsg" class="status" style="display:none;"></div>
  <div id="errorMsg"  class="error"  style="display:none;"></div>

  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <script>
    const socket        = io('/cal');
    const unitSelect    = document.getElementById('unitSelect');
    const channelSelect = document.getElementById('channelSelect');
    const minValue      = document.getElementById('minValue');
    const maxValue      = document.getElementById('maxValue');
    const saveBtn       = document.getElementById('saveRange');
    const statusMsg     = document.getElementById('statusMsg');
    const errorMsg      = document.getElementById('errorMsg');

    saveBtn.addEventListener('click', () => {
      const unit    = +unitSelect.value;
      const channel = +channelSelect.value;
      const phys1   = parseFloat(minValue.value);
      const phys2   = parseFloat(maxValue.value);

      // Validatie
      if (isNaN(phys1) || isNaN(phys2)) {
        errorMsg.textContent   = 'Vul zowel min als max sensorwaarde in.';
        errorMsg.style.display = 'block';
        return;
      }
      errorMsg.style.display  = 'none';
      statusMsg.style.display = 'none';

      // raw1=0, raw2=4095
      socket.emit('set_cal_points', {
        unit: unit,
        channel: channel,
        raw1: 819,
        phys1: phys1,
        raw2: 4095,
        phys2: phys2
      });
    });

    socket.on('cal_saved', info => {
      statusMsg.textContent   = 
        `Range opgeslagen voor module ${info.unit}, kanaal ${info.channel}: ` +
        `scale=${info.scale.toFixed(4)}, offset=${info.offset.toFixed(2)}`;
      statusMsg.style.display = 'block';
    });

    socket.on('cal_error', err => {
      errorMsg.textContent   = `Fout bij opslaan: ${err.error}`;
      errorMsg.style.display = 'block';
    });
  </script>
</body>
</html>
