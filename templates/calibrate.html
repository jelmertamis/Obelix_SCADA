<!DOCTYPE html>
<html>
<head>
  <title>Kalibratie Interface</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.min.js"></script>
  <style>
    .cal-block { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
    .cal-block h3 { margin-top: 0; }
    .cal-block label { margin-right: 10px; }
    .cal-block input { margin: 5px; }
    .cal-block button { margin: 5px; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Kalibratie per Kanaal</h1>
  <p>Voer twee meetpunten in: een lage en een hoge waarde. Gebruik de "Haal ruwe waarde" knop om de huidige sensorwaarde op te halen.</p>
  <div id="controls"></div>

  <script>
    const socket = io('/cal');
    socket.on('init_cal', calData => {
      const units = {{ units|tojson }};
      const cont = document.getElementById('controls');
      units.forEach((u, i) => {
        if (u.type === 'analog') {
          for (let ch = 0; ch < 4; ch++) {
            const key = `${i}-${ch}`;
            const cal = calData[key] || {scale: 1, offset: 0};
            const div = document.createElement('div');
            div.className = 'cal-block';
            div.innerHTML = `
              <h3>${u.name} (ID ${u.slave_id}), kanaal ${ch}</h3>
              <p>Ruwe waarde: <span id="raw-${key}">?</span> | Gekalibreerd: <span id="cal-${key}">?</span></p>
              <h4>Punt 1 (bijv. lage waarde)</h4>
              <label>Ruwe waarde: <input id="raw1-${key}" type="number" step="0.1"></label>
              <button onclick="fetchRaw(${i}, ${ch}, 1)">Haal ruwe waarde</button><br>
              <label>Fysieke waarde: <input id="phys1-${key}" type="number" step="0.01"></label>
              <h4>Punt 2 (bijv. hoge waarde)</h4>
              <label>Ruwe waarde: <input id="raw2-${key}" type="number" step="0.1"></label>
              <button onclick="fetchRaw(${i}, ${ch}, 2)">Haal ruwe waarde</button><br>
              <label>Fysieke waarde: <input id="phys2-${key}" type="number" step="0.01"></label>
              <p>Huidige kalibratie: Scale = <span id="scale-${key}">${cal.scale.toFixed(4)}</span>, Offset = <span id="offset-${key}">${cal.offset.toFixed(2)}</span></p>
              <button onclick="saveCal(${i}, ${ch})">Bereken & Opslaan</button>
              <p id="error-${key}" class="error"></p>
              <hr>`;
            cont.appendChild(div);
            socket.emit('get_raw', {unit_index: i, channel: ch});
          }
        }
      });
    });

    socket.on('raw_value', d => {
      const key = `${d.unit}-${d.channel}`;
      const rawEl = document.getElementById(`raw-${key}`);
      const calEl = document.getElementById(`cal-${key}`);
      rawEl.textContent = d.raw !== null ? d.raw : 'Err';
      calEl.textContent = d.calibrated !== null ? d.calibrated.toFixed(2) : 'Err';
    });

    socket.on('cal_saved', d => {
      const key = `${d.unit}-${d.channel}`;
      document.getElementById(`scale-${key}`).textContent = d.scale.toFixed(4);
      document.getElementById(`offset-${key}`).textContent = d.offset.toFixed(2);
      document.getElementById(`error-${key}`).textContent = '';
      alert(`Kalibratie opgeslagen voor unit ${d.unit}, kanaal ${d.channel}`);
    });

    socket.on('cal_error', d => {
      const key = `${d.unit}-${d.channel}`;
      document.getElementById(`error-${key}`).textContent = `Fout: ${d.error}`;
    });

    function fetchRaw(unit, channel, point) {
      socket.emit('get_raw', {unit_index: unit, channel: channel});
      socket.on('raw_value', d => {
        if (d.unit === unit && d.channel === channel && d.raw !== null) {
          document.getElementById(`raw${point}-${unit}-${channel}`).value = d.raw;
        }
      });
    }

    function saveCal(unit, channel) {
      const key = `${unit}-${channel}`;
      const raw1 = parseFloat(document.getElementById(`raw1-${key}`).value);
      const phys1 = parseFloat(document.getElementById(`phys1-${key}`).value);
      const raw2 = parseFloat(document.getElementById(`raw2-${key}`).value);
      const phys2 = parseFloat(document.getElementById(`phys2-${key}`).value);
      if (isNaN(raw1) || isNaN(phys1) || isNaN(raw2) || isNaN(phys2)) {
        document.getElementById(`error-${key}`).textContent = 'Vul alle velden in';
        return;
      }
      socket.emit('set_cal_points', {
        unit: unit,
        channel: channel,
        raw1: raw1,
        phys1: phys1,
        raw2: raw2,
        phys2: phys2
      });
    }
  </script>
</body>
</html>