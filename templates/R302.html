{% extends 'base.html' %}  {# Gebruik de algemene layout base.html #}

{% block title %}R302 Reactor Control{% endblock %}  {# Paginatitel #}

{% block head %}
<style>
  /* ▪️ Hoofdsectie centreren */
  section {
    display: flex;              /* Flexbox layout */
    flex-direction: column;     /* Elementen onder elkaar */
    align-items: center;        /* Horizontaal centreren */
    width: 100%;
    padding: 1rem 0;            /* Verticale marge */
  }

  /* ▪️ SVG onderkant marges */
  #reactor-diagram {
    margin-bottom: 2rem;
  }

  /* ▪️ Pomp- & compressor-stijlen */
  .pump-on {
    fill: #28a745;              /* Groen = aan */
    stroke: #333;               /* Donkere rand */
    stroke-width: 2;
    cursor: pointer;            /* Klik-cursor */
  }
  .pump-off {
    fill: #9e9e9e;              /* Grijs = inactief */
    stroke: #333;
    stroke-width: 2;
    cursor: pointer;
  }
  .compressor-on {
    fill: #28a745;              /* Groen = aan */
    stroke: #333;
    stroke-width: 2;
    cursor: pointer;
  }
  .compressor-off {
    fill: #9e9e9e;              /* Grijs = inactief */
    stroke: #333;
    stroke-width: 2;
    cursor: pointer;
  }

  /* ▪️ SVG-labelstijl */
  text.diagram-label {
    font-size: 12px;            /* Kleine tekst */
    pointer-events: none;       /* Niet klikbaar */
  }

  /* ▪️ Grid voor relay-knoppen */
  #relay-controls {
    display: grid;                                /* Grid-layout */
    grid-template-columns: repeat(6, minmax(180px, 1fr));
    gap: 1rem;                                    /* Ruimte tussen items */
    margin: 1rem auto;                            /* Centreren */
    max-width: 1200px;                            /* Max breedte */
    justify-content: center;
  }

  /* ▪️ Relay-kaart styling */
  .relay-control {
    position: relative;          /* Nodig voor pop-up */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    width: 180px;
    height: 200px;
    padding: 1rem;
    background: #fff;            /* Witte kaart */
    border-radius: 0.5rem;       /* Afgeronde hoeken */
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .relay-control h3 {
    font-size: 1.1rem;
    text-align: center;
  }

  /* ▪️ Statusknop basisstijl */
  .status-btn {
    width: 100%;
    height: 3.5rem;
    font-size: 1rem;
    font-weight: bold;
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .status-manual-on   { background: #28a745; }  /* Groen bij manueel ON */
  .status-manual-off  { background: #dc3545; }  /* Rood bij manueel OFF */
  .status-auto-on,
  .status-auto-off {
    border: 3px solid orange;   /* Oranje rand = AUTO */
    box-shadow: 0 0 6px rgba(255,165,0,0.7);
  }
  .status-auto-on  { background: #28a745; }     /* Groen bij AUTO ON */
  .status-auto-off { background: #dc3545; }     /* Rood bij AUTO OFF */

  /* ▪️ Pop-up menu */
  .mode-popup {
    position: absolute;         /* t.o.v. kaart */
    top: 70%; left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 0.25rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    min-width: 180px;
    z-index: 1000;
    visibility: hidden;         /* Standaard verborgen */
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  .mode-popup.show {
    visibility: visible;        /* Zichtbaar bij .show */
    opacity: 1;
  }
  .mode-popup button {
    width: 80%;
    height: 3rem;
    font-size: 0.9rem;
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .mode-popup .manual-on   { background: #28a745; }  /* Manueel ON */
  .mode-popup .manual-off  { background: #dc3545; }  /* Manueel OFF */
  .mode-popup .auto        { background: #ffc107; color: #333; }  /* AUTO */

  /* ▪️ Klep-labels en vormen */
  .valve-label { text-anchor: middle; }
  .valve-shape.valve-off polygon {
    stroke: #333; fill: #9e9e9e; stroke-width: 2; cursor: pointer;
  }
  .valve-shape.valve-on polygon {
    stroke: #333; fill: #28a745; stroke-width: 2; cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<section>  {# Hoofdsectie voor de UI #}
  <h1>R302 Reactor Control</h1>  {# Pagina­koptekst #}

  <!-- SVG-weergave van reactor, pompen, compressoren, klep en sensoren -->
  <svg id="reactor-diagram" width="600" height="500">
    <!-- Reactorvat R302 -->
    <rect x="250" y="100" width="100" height="200" fill="#4caf50" stroke="#333" stroke-width="3"/>
    <text x="270" y="90" style="font-size:26px" class="diagram-label">R302</text>

    <!-- Influent-pomp P301 -->
    <line x1="150" y1="200" x2="250" y2="200" stroke="black" stroke-width="2"/>
    <circle id="pump-0" cx="200" cy="200" r="15" class="pump-off"/>
    <text x="185" y="180" class="diagram-label">P301</text>

    <!-- Effluent-pomp P303A -->
    <line x1="350" y1="200" x2="450" y2="200" stroke="black" stroke-width="2"/>
    <circle id="pump-1" cx="400" cy="200" r="15" class="pump-off"/>
    <text x="380" y="180" class="diagram-label">P303A</text>

    <!-- Nutriënten-pomp P406 -->
    <line x1="150" y1="325" x2="200" y2="325" stroke="black" stroke-width="2"/>
    <line x1="200" y1="325" x2="200" y2="250" stroke="black" stroke-width="2"/>
    <line x1="200" y1="250" x2="250" y2="250" stroke="black" stroke-width="2"/>
    <circle id="pump-2" cx="200" cy="287.5" r="15" class="pump-off"/>
    <text x="155" y="290" class="diagram-label">P406</text>

    <!-- Compressoren K303 & K304 -->
    <g transform="translate(-25, 0)">
      <line x1="300" y1="300" x2="300" y2="400" stroke="black" stroke-width="2"/>
      <circle id="compressor-3" cx="300" cy="375" r="15" class="compressor-off"/>
      <text x="250" y="380" class="diagram-label">K303</text>
      <line x1="350" y1="300" x2="350" y2="400" stroke="black" stroke-width="2"/>
      <circle id="compressor-4" cx="350" cy="375" r="15" class="compressor-off"/>
      <text x="370" y="380" class="diagram-label">K304</text>
    </g>
    <!-- Sensorwaarden (pH, DO, Temp, Level) -->
    <text x="260" y="140" class="diagram-label" id="sensor-ph">pH: --</text>
    <text x="260" y="180" class="diagram-label" id="sensor-do">DO: --</text>
    <text x="260" y="220" class="diagram-label" id="sensor-temp">Temp: -- °C</text>
    <text x="260" y="260" class="diagram-label" id="sensor-level">Level: -- %</text>

    <!-- Verwarmingsklep A503 -->
    <g id="valve-5" class="valve-shape valve-off" transform="translate(400,300)">
      <polygon points="-10,-10 0,0 -10,10"/>
      <polygon points="10,-10 0,0 10,10"/>
      <text x="0" y="25" class="diagram-label valve-label">A503</text>
    </g>
  </svg>

  <h2>Relay Controls</h2>  {# Sectietitel voor relaisbediening #}
  <div id="relay-controls"></div>  {# Wordt via JS gevuld #}
</section>
{% endblock %}

{% block scripts %}
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
<script>
  // Maak Socket.IO verbindingen
  const r302socket   = io('/r302');      // Relay-namespace
  const sensorSocket = io('/sensors');   // Sensor-namespace

  // Labels voor UI
  const relayLabels = {
    0: 'Influent Pump',
    1: 'Effluent Pump',
    2: 'Nutrient Pump',
    3: 'Compressor (K303)',
    4: 'Compressor (K304)',
    5: 'Heating Valve (A503)'
  };

  // Houd per relais bij welke mode actief is
  const relayModes = {};

  // Map van coil ID → SVG-element en type
  const svgMap = {
    0: { id: 'pump-0',       type: 'pump'       },
    1: { id: 'pump-1',       type: 'pump'       },
    2: { id: 'pump-2',       type: 'pump'       },
    3: { id: 'compressor-3', type: 'compressor' },
    4: { id: 'compressor-4', type: 'compressor' },
    5: { id: 'valve-5',      type: 'valve'      }
  };

  // Bouw de relay-kaarten dynamisch
  function buildRelayControls() {
    const container = document.getElementById('relay-controls');
    container.innerHTML = '';            // Leeg eerst
    for (let coil = 0; coil <= 5; coil++) {
      relayModes[coil] = 'AUTO';         // Default mode
      container.insertAdjacentHTML('beforeend', `
        <div class="relay-control" id="relay-${coil}">
          <h3>${relayLabels[coil]}</h3>
          <button class="status-btn status-auto-off" id="status-${coil}">
            Loading…
          </button>
          <div class="mode-popup" id="popup-${coil}">
            <button class="manual-on"  data-coil="${coil}">Manual ON</button>
            <button class="manual-off" data-coil="${coil}">Manual OFF</button>
            <button class="auto"       data-coil="${coil}">AUTO</button>
          </div>
        </div>`);
    }
  }

  // Update knop- en SVG-status van een relais
  function updateRelayStatus(coil, physOn, mode) {
    const btn = document.getElementById(`status-${coil}`);
    btn.className = 'status-btn';        // Reset classes
    relayModes[coil] = mode;             // Bijwerken mode

    // Tekst en kleur op basis van mode
    if (mode === 'MANUAL_ON') {
      btn.textContent = 'Manual ON';
      btn.classList.add('status-manual-on');
    }
    else if (mode === 'MANUAL_OFF') {
      btn.textContent = 'Manual OFF';
      btn.classList.add('status-manual-off');
    }
    else {
      btn.textContent = physOn ? 'Auto ON' : 'Auto OFF';
      btn.classList.add(physOn ? 'status-auto-on' : 'status-auto-off');
    }

    // Pas ook het SVG-element aan (pomp/compressor/klep)
    const map = svgMap[coil];
    if (map) {
      const el = document.getElementById(map.id);
      if (el) {
        const onCls  = map.type === 'pump'        ? 'pump-on'
                      : map.type === 'compressor'? 'compressor-on'
                      : 'valve-on';
        const offCls = map.type === 'pump'        ? 'pump-off'
                      : map.type === 'compressor'? 'compressor-off'
                      : 'valve-off';
        el.classList.toggle(onCls, physOn);
        el.classList.toggle(offCls, !physOn);
      }
    }
  }

  // Verberg alle pop-ups
  function hideAllPopups() {
    document.querySelectorAll('.mode-popup.show')
            .forEach(p => p.classList.remove('show'));
  }

  // Init
  buildRelayControls();

  // Klik op statusknop toont pop-up
  document.getElementById('relay-controls').addEventListener('click', e => {
    if (e.target.classList.contains('status-btn')) {
      e.stopPropagation();
      const coil = e.target.id.split('-')[1];
      const popup = document.getElementById(`popup-${coil}`);
      const wasVisible = popup.classList.contains('show');
      hideAllPopups();
      if (!wasVisible) popup.classList.add('show');
      return;
    }
    // Keuze in pop-up (Manual ON/OFF of AUTO)
    const choice = e.target.closest('.mode-popup button');
    if (choice) {
      e.stopPropagation();
      const coil = Number(choice.dataset.coil);
      let mode = 'AUTO';
      if (choice.classList.contains('manual-on'))   mode = 'MANUAL_ON';
      else if (choice.classList.contains('manual-off')) mode = 'MANUAL_OFF';
      r302socket.emit('set_mode', { coil, mode });  // Verzend naar server
      updateRelayStatus(coil, mode !== 'MANUAL_OFF', mode);
      hideAllPopups();
    }
  });

  // Klik elders sluit pop-ups
  document.addEventListener('click', hideAllPopups);

  // Ontvang initiële relay-status van server
  r302socket.on('r302_init', status =>
    Object.entries(status).forEach(([c, info]) =>
      updateRelayStatus(c, info.physical, info.mode)
    )
  );

  // Ontvang latere relay-updates
  r302socket.on('r302_update', status =>
    Object.entries(status).forEach(([c, info]) =>
      updateRelayStatus(c, info.physical, info.mode)
    )
  );

  // Ontvang sensorwaarden en werk SVG-labels bij
  sensorSocket.on('sensor_update', readings => {
    readings
      .filter(r => r.slave_id === 5)           // Alleen R302
      .forEach(r => {
        const idMap = {
          0: 'sensor-level',
          1: 'sensor-ph',
          2: 'sensor-temp',
          3: 'sensor-do'
        };
        const elId = idMap[r.channel];
        if (elId) {
          const suffix = elId === 'sensor-temp' ? ' °C'
                       : elId === 'sensor-do'   ? ' mg/L'
                       : elId === 'sensor-level'? ' %'
                       : '';
          const elem = document.getElementById(elId);
          elem.textContent = `${elem.textContent.split(':')[0]}: ${r.value.toFixed(2)}${suffix}`;
        }
      });
  });
</script>
{% endblock %}
