<!-- templates/R302.html -->
{% extends 'base.html' %}

{% block title %}R302 Reactor Control{% endblock %}

{% block content %}
<section>
  <h1>R302 Reactor Control</h1>

  <!-- Sensors -->
  <h2>Sensors</h2>
  <table class="sensor-table">
    <thead>
      <tr>
        <th>Naam</th><th>Ruwe Waarde</th><th>Gecalibreerd</th><th>Eenheid</th>
      </tr>
    </thead>
    <tbody id="sensorBody">
      <!-- Wordt door JS gevuld -->
    </tbody>
  </table>
</section>

<!-- Pumps -->
<section>
  <h2>Pumps</h2>
  <div class="control-group" id="pumps">
    <!-- JS vult hier pump-cards -->
  </div>
</section>

<!-- Compressors -->
<section>
  <h2>Compressors ON/OFF</h2>
  <div class="control-group" id="compressors">
    <!-- JS vult hier compressor-cards -->
  </div>
</section>

<!-- Analog Outputs -->
<section>
  <h2>Analog Outputs</h2>
  <div class="control-group" id="aio-outputs">
    <!-- JS vult hier AIO-cards -->
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
<script>
  // R302 namespace
  const r302socket = io('/r302');

  r302socket.on('r302_init', data => {
    // Pumps (relays 0–2)
    const pumpDiv = document.getElementById('pumps');
    pumpDiv.innerHTML = '';
    Object.entries(data.pumps).forEach(([coil, p]) => {
      pumpDiv.innerHTML += `
        <div class="card pump" id="pump-${coil}">
          <h3>${p.label}</h3>
          <label>Mode:
            <select onchange="setPumpMode(${coil}, this.value)">
              <option${p.mode==='OFF'?' selected':''}>OFF</option>
              <option${p.mode==='AUTO'?' selected':''}>AUTO</option>
              <option${p.mode==='ON'?' selected':''}>ON</option>
            </select>
          </label>
        </div>`;
    });

    // Compressors ON/OFF + speed (relays 3–4 + AIO indices)
    const compDiv = document.getElementById('compressors');
    compDiv.innerHTML = '';
    Object.entries(data.compressors).forEach(([coil, c]) => {
      compDiv.innerHTML += `
        <div class="card compressor" id="comp-${coil}">
          <h3>${c.label}</h3>
          <label>Mode:
            <select onchange="setCompMode(${coil}, this.value)">
              <option${c.mode==='OFF'?' selected':''}>OFF</option>
              <option${c.mode==='AUTO'?' selected':''}>AUTO</option>
              <option${c.mode==='ON'?' selected':''}>ON</option>
            </select>
          </label>
          <label>Speed (%):
            <input type="number" step="0.1" min="0" max="100"
                   value="${c.freq}"
                   onchange="setCompFreq(${coil}, this.value)">
          </label>
        </div>`;
    });

    // Analog outputs (slave 10 channels)
    const aioDiv = document.getElementById('aio-outputs');
    aioDiv.innerHTML = '';
    data.aio.forEach(a => {
      aioDiv.innerHTML += `
        <div class="card aio" id="aio-${a.channel}">
          <h3>${a.label}</h3>
          <label>Percent Out:
            <input type="number" step="0.1" min="0" max="100"
                   value="${a.percent_out ?? ''}"
                   onchange="setAio(${a.channel}, this.value)">
          </label>
        </div>`;
    });
  });

  // Helper emits
  function setPumpMode(coil, mode) {
    r302socket.emit('set_pump_mode', { pump: coil, mode });
  }
  function setCompMode(coil, mode) {
    r302socket.emit('set_compressor_mode', { compressor: coil, mode });
  }
  function setCompFreq(coil, freq) {
    r302socket.emit('set_compressor_freq', { compressor: coil, freq });
  }
  function setAio(ch, pct) {
    r302socket.emit('aio_set', { channel: ch, percent: pct });
  }

  // Separate socket for sensor updates
  const sensorSocket = io('/sensors');
  // Map channel → label for R302 sensors
  const sensorLabels = {
    0: 'Level Sensor',
    1: 'pH',
    2: 'Temperature',
    3: 'Dissolved Oxygen'
  };

  sensorSocket.on('sensor_update', readings => {
    // Filter op slave ID 5 (jouw R302 sensoren)
    const r302Readings = readings.filter(r => r.slave_id === 5);
    const tbody = document.getElementById('sensorBody');
    tbody.innerHTML = '';
    r302Readings.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${sensorLabels[r.channel] || 'Kanaal ' + r.channel}</td>
        <td>${r.raw}</td>
        <td>${r.value.toFixed(2)}</td>
        <td>${r.unit || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  });
</script>
{% endblock %}
