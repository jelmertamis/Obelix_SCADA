<!-- templates/R302.html -->
{% extends 'base.html' %}

{% block title %}R302 Reactorbesturing{% endblock %}

{% block content %}
  <h1>R302 Reactorbesturing</h1>

  <!-- Sensors -->
  <section>
    <h2>Sensors</h2>
    <table>
      <thead>
        <tr>
          <th>#</th><th>Raw</th><th>Value</th>
        </tr>
      </thead>
      <tbody id="sensorBody"></tbody>
    </table>
  </section>

  <!-- Pumps -->
  <section>
    <h2>Pumps</h2>
    <div class="control-group">
      <div class="card" id="pump-influent">
        <h3>Influent Pump</h3>
        <label for="mode-influent">Mode</label>
        <select id="mode-influent" onchange="setPumpMode('influent', this.value)">
          <option>OFF</option><option>AUTO</option><option>ON</option>
        </select>
      </div>
      <div class="card" id="pump-nutrient">
        <h3>Nutrient Pump</h3>
        <label for="mode-nutrient">Mode</label>
        <select id="mode-nutrient" onchange="setPumpMode('nutrient', this.value)">
          <option>OFF</option><option>AUTO</option><option>ON</option>
        </select>
      </div>
      <div class="card" id="pump-effluent">
        <h3>Effluent Pump</h3>
        <label for="mode-effluent">Mode</label>
        <select id="mode-effluent" onchange="setPumpMode('effluent', this.value)">
          <option>OFF</option><option>AUTO</option><option>ON</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Compressors -->
  <section>
    <h2>Compressors</h2>
    <div class="control-group">
      <div class="card" id="compressor1">
        <h3>Compressor 1</h3>
        <label for="comp1-mode">Mode</label>
        <select id="comp1-mode" onchange="setCompMode(1, this.value)">
          <option>OFF</option><option>AUTO</option><option>ON</option>
        </select>
        <label for="comp1-freq">Frequency (%)</label>
        <input type="number" id="comp1-freq" step="0.1" min="0" max="100"
               onchange="setCompFreq(1, this.value)">
      </div>
      <div class="card" id="compressor2">
        <h3>Compressor 2</h3>
        <label for="comp2-mode">Mode</label>
        <select id="comp2-mode" onchange="setCompMode(2, this.value)">
          <option>OFF</option><option>AUTO</option><option>ON</option>
        </select>
        <label for="comp2-freq">Frequency (%)</label>
        <input type="number" id="comp2-freq" step="0.1" min="0" max="100"
               onchange="setCompFreq(2, this.value)">
      </div>
    </div>
  </section>

  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <script>
    const socket = io('/r302');

    socket.on('r302_init', data => {
      // sensors
      const sb = document.getElementById('sensorBody');
      sb.innerHTML = '';
      data.sensors.forEach((s,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${s.raw||'—'}</td><td>${s.value||'—'}</td>`;
        sb.appendChild(tr);
      });
      // pumps
      ['influent','nutrient','effluent'].forEach(k=>{
        document.getElementById(`mode-${k}`).value = data.pumps[k];
      });
      // compressors
      [1,2].forEach(n=>{
        const c = data.compressors[n];
        document.getElementById(`comp${n}-mode`).value = c.mode;
        document.getElementById(`comp${n}-freq`).value = c.freq;
      });
    });

    socket.on('pump_mode_updated', m=> {
      document.getElementById(`mode-${m.pump}`).value = m.mode;
    });
    socket.on('compressor_mode_updated', m=>{
      document.getElementById(`comp${m.compressor}-mode`).value = m.mode;
    });
    socket.on('compressor_freq_updated', m=>{
      document.getElementById(`comp${m.compressor}-freq`).value = m.freq;
    });

    function setPumpMode(pump,mode){
      socket.emit('set_pump_mode',{pump,mode});
    }
    function setCompMode(n,mode){
      socket.emit('set_compressor_mode',{compressor:n,mode});
    }
    function setCompFreq(n,freq){
      socket.emit('set_compressor_freq',{compressor:n,freq});
    }
  </script>
{% endblock %}
