<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relay Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
  <style>
    .onoff-button {
      padding: .5em 1em;
      margin: .5em;
      border: none;
      cursor: pointer;
      border-radius: .25em;
      font-size: 1rem;
    }
    .onoff-button.on  { background: lightgreen; }
    .onoff-button.off { background: lightcoral; }
  </style>
</head>
<body>
  <div id="relays-container">
    {% for unit in relays %}
      <div class="relay-unit" data-unit-idx="{{ unit.idx }}">
        <h3>{{ unit.name }}</h3>
        {% for coil_idx in range(8) %}
          <button
            class="onoff-button off"
            data-unit-idx="{{ unit.idx }}"
            data-coil-idx="{{ coil_idx }}"
          >OFF</button>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const socket    = io('/relays');
    const container = document.getElementById('relays-container');

    // 1) Init: zet booleans om in ON/OFF en pas class & label aan
    socket.on('init_relays', units => {
      units.forEach(u => {
        u.states.forEach((state, coilIdx) => {
          const btn = container.querySelector(
            `.onoff-button[data-unit-idx="${u.idx}"][data-coil-idx="${coilIdx}"]`
          );
          btn.classList.toggle('on',  state);
          btn.classList.toggle('off', !state);
          btn.textContent = state ? 'ON' : 'OFF';
        });
      });
    });

    // 2) Na toggle: update met de precieze state uit de server
    socket.on('relay_toggled', data => {
      const { unit_idx, coil_idx, state } = data;
      const btn = container.querySelector(
        `.onoff-button[data-unit-idx="${unit_idx}"][data-coil-idx="${coil_idx}"]`
      );
      btn.classList.toggle('on',  state === 'ON');
      btn.classList.toggle('off', state === 'OFF');
      btn.textContent = state;
    });

    // 3) Klik-handler: bepaal nieuwe gewenste state en stuur die mee
    container.addEventListener('click', e => {
      if (!e.target.matches('.onoff-button')) return;
      const btn      = e.target;
      const unitIdx  = Number(btn.dataset.unitIdx);
      const coilIdx  = Number(btn.dataset.coilIdx);
      // als hij aan is, willen we OFF, anders ON
      const newState = btn.classList.contains('on') ? 'OFF' : 'ON';
      socket.emit('toggle_relay', {
        unit_idx: unitIdx,
        coil_idx: coilIdx,
        state:    newState
      });
    });
  });
  </script>
</body>
</html>
