{% extends 'base.html' %}

{% block title %}Relay Control{% endblock %}

{% block content %}
  <h1>Relay Control</h1>

  <div id="relaysContainer"></div>

  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <script>
    const socket = io('/relays');
    const container = document.getElementById('relaysContainer');

    // Bij connect: modules tekenen
    socket.on('init_relays', modules => {
      container.innerHTML = '';
      modules.forEach(mod => {
        // Module-wrapper
        const wrap = document.createElement('div');
        wrap.className = 'relay-module';
        container.appendChild(wrap);

        // Titel
        const title = document.createElement('h2');
        title.textContent = `${mod.name} (ID ${mod.slave_id})`;
        wrap.appendChild(title);

        // Buttons-container
        const btns = document.createElement('div');
        btns.className = 'relay-buttons';
        wrap.appendChild(btns);

        // Per coil een on/off-knop
        mod.states.forEach((state, coil) => {
          const btn = document.createElement('button');
          btn.className = `onoff-button ${state.toLowerCase()}`;
          btn.id        = `relay-${mod.idx}-${coil}`;
          btn.textContent = coil;
          btn.onclick = () => {
            socket.emit('toggle_relay', {
              unit_idx: mod.idx,
              coil_idx: coil
            });
          };
          btns.appendChild(btn);
        });
      });
    });

    // Update na toggle
    socket.on('relay_toggled', msg => {
      const btn = document.getElementById(`relay-${msg.unit_idx}-${msg.coil_idx}`);
      btn.classList.toggle('on',  msg.state === 'ON');
      btn.classList.toggle('off', msg.state === 'OFF');
    });

    // Foutmeldingen
    socket.on('relay_error', err => {
      alert('Relay error: ' + err.error);
    });
  </script>
{% endblock %}
