{% extends "base.html" %}

{% block title %}Relays{% endblock %}

{% block content %}
<section id="relaysContainer">
  {% for unit in relays %}
    <div class="relay-module" data-unit-idx="{{ unit.idx }}">
      <div class="relay-header">
        <h2>{{ unit.name }}</h2>
        <small>Slave ID: {{ unit.slave_id }}</small>
      </div>
      <div class="relay-buttons">
        {% for coil_idx in range(unit.coil_count) %}
          <button
            class="onoff-button off"
            data-unit-idx="{{ unit.idx }}"
            data-coil-idx="{{ coil_idx }}"
          >OFF</button>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</section>
{% endblock %}

{% block scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const socket    = io('/relays');
      const container = document.getElementById('relaysContainer');

      // 1) Init: booleans â†’ ON/OFF en juiste classes
      socket.on('init_relays', units => {
        units.forEach(u => {
          u.states.forEach((state, coilIdx) => {
            const btn = container.querySelector(
              `.onoff-button[data-unit-idx="${u.idx}"][data-coil-idx="${coilIdx}"]`
            );
            btn.classList.toggle('on',  state);
            btn.classList.toggle('off', !state);
            btn.textContent = state ? 'ON' : 'OFF';
          });
        });
      });

      // 2) Na toggle: update met precieze state uit server
      socket.on('relay_toggled', data => {
        const { unit_idx, coil_idx, state } = data;
        const btn = container.querySelector(
          `.onoff-button[data-unit-idx="${unit_idx}"][data-coil-idx="${coil_idx}"]`
        );
        btn.classList.toggle('on',  state === 'ON');
        btn.classList.toggle('off', state === 'OFF');
        btn.textContent = state;
      });

      // 3) Klik-handler: bepaal nieuwe gewenste state en stuur mee
      container.addEventListener('click', e => {
        if (!e.target.matches('.onoff-button')) return;
        const btn      = e.target;
        const unitIdx  = Number(btn.dataset.unitIdx);
        const coilIdx  = Number(btn.dataset.coilIdx);
        const newState = btn.classList.contains('on') ? 'OFF' : 'ON';
        socket.emit('toggle_relay', {
          unit_idx: unitIdx,
          coil_idx: coilIdx,
          state:    newState
        });
      });

      // 4) Foutmeldingen loggen
      socket.on('relay_error', err => {
        console.error('Relay error:', err.error);
      });
    });
  </script>
{% endblock %}
