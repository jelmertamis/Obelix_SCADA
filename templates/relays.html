<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Relay Controls</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; text-align: center; }
    h1 { margin-bottom: 1rem; }
    table { border-collapse: collapse; margin: auto; width: 90%; }
    th, td { border:1px solid #ccc; padding:8px; text-align: center; }
    th { background: #f0f0f0; }
    button {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      color: white;
      cursor: pointer;
    }
    .btn-on  { background-color: #28a745; }
    .btn-off { background-color: #dc3545; }
    .btn-on:hover  { background-color: #218838; }
    .btn-off:hover { background-color: #c82333; }
    .module-name { font-weight: bold; }
  </style>
</head>
<body>
  <h1>Relay Controls</h1>
  <p><a href="{{ url_for('index') }}">‚Üê Terug naar Dashboard</a></p>
  <table>
    <thead>
      <tr>
        <th>Module (Slave ID)</th>
        {% for ch in range(8) %}
        <th>Coil {{ ch }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody id="relayBody">
      <!-- JS vult hier de rijen in -->
    </tbody>
  </table>

  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <script>
    const socket = io('/relays');

    socket.on('init_relays', relays => {
      renderTable(relays);
    });

    socket.on('relay_toggled', data => {
      const btn = document.querySelector(
        'button[data-unit="'+data.unit_idx+'"][data-coil="'+data.coil_idx+'"]'
      );
      if (!btn) return;
      btn.textContent = data.state;
      btn.className = data.state === 'ON' ? 'btn-on' : 'btn-off';
    });

    function renderTable(relays) {
      const tbody = document.getElementById('relayBody');
      tbody.innerHTML = '';
      relays.forEach(r => {
        const tr = document.createElement('tr');
        const tdMod = document.createElement('td');
        tdMod.textContent = r.name + ' (' + r.slave_id + ')';
        tdMod.className = 'module-name';
        tr.appendChild(tdMod);
        r.states.forEach((state, ch) => {
          const td = document.createElement('td');
          const btn = document.createElement('button');
          btn.textContent = state;
          btn.className = state === 'ON' ? 'btn-on' : 'btn-off';
          btn.setAttribute('data-unit',  r.idx);
          btn.setAttribute('data-coil',  ch);
          btn.addEventListener('click', () => {
            socket.emit('toggle_relay', {
              unit_idx: r.idx,
              coil_idx: ch
            });
          });
          td.appendChild(btn);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
