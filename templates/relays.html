{% extends "base.html" %}
{% block title %}Relay Control{% endblock %}

{% block content %}
<section class="container">
  <h1>Relay Control</h1>
  <div id="relaysContainer">
    {% for r in relays %}
      <div class="relay-module" data-unit-idx="{{ r.idx }}">
        <div class="relay-header">
          <h2>{{ r.name }}<br><small>(ID {{ r.id }})</small></h2>
        </div>
        <div class="relay-buttons">
          {% for coil in r.coils %}
            <button
              class="onoff-button {{ 'on' if coil else 'off' }}"
              data-coil-idx="{{ loop.index0 }}">
              {{ coil ? 'ON' : 'OFF' }}
            </button>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const socket = io("/relays");
    const container = document.getElementById("relaysContainer");

    // 1) Listen for the initial states
    socket.on("init_relays", relays => {
      relays.forEach(r => {
        const moduleEl = container.querySelector(
          `.relay-module[data-unit-idx="${r.idx}"]`
        );
        if (!moduleEl) return;
        r.states.forEach((s, coil) => {
          const btn = moduleEl.querySelector(
            `.onoff-button[data-coil-idx="${coil}"]`
          );
          btn.classList.toggle("on",  s === "ON");
          btn.classList.toggle("off", s !== "ON");
          btn.textContent = s;
        });
      });
    });

    // 2) Emit toggles
    container.addEventListener("click", e => {
      if (!e.target.matches(".onoff-button")) return;
      const btn     = e.target;
      const coilIdx = Number(btn.dataset.coilIdx);
      const unitIdx = Number(btn.closest(".relay-module").dataset.unitIdx);
      socket.emit("toggle_relay", { unit_idx: unitIdx, coil_idx: coilIdx });
    });

    // 3) Update after server confirms
    socket.on("relay_toggled", msg => {
      const moduleEl = container.querySelector(
        `.relay-module[data-unit-idx="${msg.unit_idx}"]`
      );
      if (!moduleEl) return;
      const btn = moduleEl.querySelector(
        `.onoff-button[data-coil-idx="${msg.coil_idx}"]`
      );
      btn.classList.toggle("on",  msg.state === "ON");
      btn.classList.toggle("off", msg.state !== "ON");
      btn.textContent = msg.state;
    });

    socket.on("relay_error", err => {
      alert("Fout bij schakelen: " + err.error);
    });
  });
</script>
{% endblock %}
