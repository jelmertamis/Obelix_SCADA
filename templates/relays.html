{% extends "base.html" %}
{% block title %}Relay Control{% endblock %}

{% block content %}
<section class="container">
  <h1>Relay Control</h1>
  <div id="relaysContainer">
    {% for r in relays %}
      <div class="relay-module" data-unit-idx="{{ r.idx }}">
        <div class="relay-header">
          <h2>{{ r.name }}<br><small>(ID {{ r.id }})</small></h2>
        </div>
        <div class="relay-buttons">
          {% for coil in r.coils %}
            <button
              class="onoff-button {{ 'on' if coil else 'off' }}"
              data-coil-idx="{{ loop.index0 }}">
              {{ loop.index0 }}
            </button>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socket = io("/relays");

  document.querySelectorAll(".onoff-button").forEach(button => {
    button.addEventListener("click", () => {
      const coilIdx = parseInt(button.dataset.coilIdx);
      const unitEl = button.closest(".relay-module");
      const unitIdx = parseInt(unitEl.dataset.unitIdx);

      socket.emit("toggle_relay", {
        unit_idx: unitIdx,
        coil_idx: coilIdx
      });
    });
  });

  socket.on("relay_toggled", msg => {
    const unitEl = document.querySelector(`.relay-module[data-unit-idx='${msg.unit_idx}']`);
    if (!unitEl) return;

    const button = unitEl.querySelector(`.onoff-button[data-coil-idx='${msg.coil_idx}']`);
    if (!button) return;

    button.classList.remove("on", "off");
    button.classList.add(msg.state.toLowerCase());
  });

  socket.on("relay_error", msg => {
    alert("Fout bij schakelen: " + msg.error);
  });
</script>
{% endblock %}
