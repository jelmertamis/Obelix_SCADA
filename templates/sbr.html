<!-- templates/sbr.html -->
{% extends 'base.html' %}

{% block title %}SBR Configuratie & Status{% endblock %}

{% block head %}
<style>
  section.sbr-config {
    display: flex; flex-direction: column; align-items: center;
    padding: 1rem; width: 100%;
  }
  .sbr-phase-list {
    width: 100%; max-width: 700px; margin-top: 1rem;
    display: flex; flex-direction: column; gap: 0.75rem;
  }
  .phase-box {
    display: grid;
    grid-template-columns:
      2fr /* Naam */
      1fr /* Criterium */
      1fr /* Actueel */
      1fr /* Doel */
      2fr /* Invoer + knop */;
    align-items: center;
    background: #f9f9f9;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    gap: 0.5rem;
    transition: background 0.3s;
  }
  .phase-box.active { background: #28a745; color: #fff; }
  section.sbr-config.paused .phase-box.active {
    background: #ffc107; color: #333;
  }
  .phase-name { font-weight: bold; }
  .phase-criterion,
  .phase-actual,
  .phase-target { text-align: center; }
  .phase-input {
    width: 4rem; padding: 0.3rem; margin-right: 0.5rem;
    border: 1px solid #ccc; border-radius: 0.25rem;
  }
  .phase-set-btn {
    padding: 0.7rem 1rem; border: none; border-radius: 0.25rem;
    background: #007bff; color: #fff; cursor: pointer;
  }
  .phase-set-btn:hover { background: #0056b3; }
  .control_button {
    padding: 1.2rem 1rem; border: none; border-radius: 0.25rem;
    background: #007bff; color: #fff; cursor: pointer;
    font-size: 1.2rem;
    font-weight: bold;
  }
  .control_button:hover { background: #0056b3; }
</style>
<link rel="stylesheet" href="{{ url_for('static', filename='css/compressor-modal.css') }}">

{% endblock %}

{% block content %}
<section class="sbr-config" id="sbr-config-section">
  <h1>SBR Configuratie & Status</h1>

  <div id="cycle-timer" style="font-size:1.2rem; margin-bottom:0.5rem;">
    Cyclus: 00:00
  </div>
  <div style="margin-bottom:1rem;">
    <button id="btn-toggle" class="control_button">Start Cycle</button>
    <button id="btn-reset"  class="control_button">Reset Cycle</button>

    <p id="cycle-max-display" style="margin:0.5rem 0; font-weight:bold;">
      Huidige limiet: <span id="cycle-max-text">--</span> min
    </p>
    <p id="heat-set-display" style="margin:0.5rem 0; font-weight:bold;">
      Heat ON: <span id="heat-on-text">--</span> °C, Heat OFF: <span id="heat-off-text">--</span> °C
    </p>

    <!-- Nieuw: Max Cycle Time instellen -->
    <label style="font-size:1rem; margin:0 0 0 1rem;">
      Max Cycle Time (min):
      <input type="number" id="cycle-max-input" min="0" step="1" value="" style="width:4em; padding:0.3rem; border:1px solid #ccc; border-radius:0.25rem;">
    </label>
    <button id="btn-set-cycle-max" class="control_button">Set</button>
    
    <!-- Nieuw: Heating Valve setpoints instellen -->
    <label style="font-size:1rem; margin:0 1rem 0 0;">
      Heat ON (°C):
      <input type="number" id="heat-on-input" min="0" step="0.1" value="" style="width:4em; padding:0.3rem; border:1px solid #ccc; border-radius:0.25rem;">
    </label>
    <label style="font-size:1rem; margin-right:1rem;">
      Heat OFF (°C):
      <input type="number" id="heat-off-input" min="0" step="0.1" value="" style="width:4em; padding:0.3rem; border:1px solid #ccc; border-radius:0.25rem;">
    </label>
    <button id="btn-set-heat" class="control_button">Set Heat</button>
  
    <button id="compressor-open" class="control_button">Compressor Instellingen</button>

  </div>
  
  <div class="sbr-phase-list">
    {% for key,label in [
         ('influent','Influent'),
         ('react','React'),
         ('effluent','Effluent'),
         ('wait','Wait'),
         ('dose_nutrients', 'Dose nutrients'),
         ('wait_after_N', 'Wait after N')
       ] %}
    <div class="phase-box" id="phase-{{ key }}-box">
      <div class="phase-name">{{ label }}</div>
      <div class="phase-criterion">
        {% if key in ['influent', 'effluent'] %}
          Level
        {% else %}
          Time
        {% endif %}
      </div>
      <div class="phase-actual" id="{{ key }}-actual">--</div>
      <div class="phase-target" id="{{ key }}-target">--</div>
      <div>
        <input
          type="number" step="0.1" min="0"
          class="phase-input"
          id="{{ key }}-input"
          placeholder="{% if key in ['influent','effluent'] %}Set level{% else %}min{% endif %}"
        >
        <button class="phase-set-btn" id="btn-set-{{ key }}">Set</button>
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<!-- Compressor Modal (in sbr.html) -->
<div id="compressor-modal" class="modal">
  <div class="modal-content">
    <span id="compressor-close" class="modal-close">&times;</span>
    <h2>Compressor Instellingen</h2>

    <form id="compressor-form">
      <table class="compressor-table">
        <thead>
          <tr>
            <th>Fase</th>
            <th>K303 ON/OFF</th><th>Huidig</th><th>K303 %</th><th>Huidig</th>
            <th>K304 ON/OFF</th><th>Huidig</th><th>K304 %</th><th>Huidig</th>
          </tr>
        </thead>
        <tbody>
          {% for phase in ['influent','react','effluent','wait','dose_nutrients','wait_after_N'] %}
          <tr data-phase="{{ phase }}">
            <td>{{ phase.replace('_',' ')|upper }}</td>
            <td>
              <select name="{{ phase }}_k303_on" class="compressor-onoff">
                <option>ON</option><option>OFF</option>
              </select>
            </td>
            <td><span id="{{phase}}_k303_on_current">–</span></td>

            <td>
              <input type="number" name="{{ phase }}_k303_pct" class="compressor-percent">
            </td>
            <td><span id="{{phase}}_k303_pct_current">–</span></td>

            <td>
              <select name="{{ phase }}_k304_on" class="compressor-onoff">
                <option>ON</option><option>OFF</option>
              </select>
            </td>
            <td><span id="{{phase}}_k304_on_current">–</span></td>

            <td>
              <input type="number" name="{{ phase }}_k304_pct" class="compressor-percent">
            </td>
            <td><span id="{{phase}}_k304_pct_current">–</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="actions" style="text-align:right; margin-top:1rem;">
        <button type="submit" id="compressor-save" class="btn">Opslaan</button>
      </div>
    </form>

  </div>
</div>


{% endblock %}

{% block scripts %}
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/sbr.js') }}"></script>
<script src="{{ url_for('static', filename='js/compressor-modal.js') }}"></script>
{% endblock %}
