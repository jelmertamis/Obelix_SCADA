<!-- templates/sbr.html -->
{% extends 'base.html' %}

{% block title %}SBR Configuratie & Status{% endblock %}

{% block head %}
<style>
  section.sbr-config {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    width: 100%;
  }
  .sbr-phase-list {
    width: 100%;
    max-width: 500px;
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .phase-box {
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    align-items: center;
    background: #f9f9f9;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 1rem;
    gap: 0.5rem;
    transition: background 0.3s;
  }
  .phase-box.active { background: #28a745; color: #fff; }
  section.sbr-config.paused .phase-box.active {
    background: #ffc107;
    color: #333;
  }
  .phase-name { font-weight: bold; }
  .phase-progress { text-align: right; }
  .phase-input {
    width: 4rem;
    padding: 0.3rem;
    font-size: 0.9rem;
    border: 1px solid #ccc;
    border-radius: 0.25rem;
  }
  .phase-set-btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
    border: none;
    border-radius: 0.25rem;
    background: #007bff;
    color: #fff;
    cursor: pointer;
  }
  .phase-set-btn:hover { background: #0056b3; }
</style>
{% endblock %}

{% block content %}
<section class="sbr-config" id="sbr-config-section">
  <h1>SBR Configuratie & Status</h1>
  <div style="margin-top:1rem;">
    <button id="btn-toggle" class="phase-set-btn">Start Cycle</button>
    <button id="btn-reset"  class="phase-set-btn">Reset Cycle</button>
  </div>
  <div class="sbr-phase-list">
    {% for key,label in [('influent','Influent'),('react','React'),('effluent','Effluent'),('wait','Wait')] %}
    <div class="phase-box" id="phase-{{ key }}-box">
      <div class="phase-name">{{ label }}</div>
      <div class="phase-progress" id="{{ key }}-progress">0 / 0 s</div>
      <input type="number" step="0.1" min="0.1"
             class="phase-input" id="{{ key }}-input" placeholder="min">
      <button class="phase-set-btn" data-phase="{{ key }}">Set</button>
    </div>
    {% endfor %}
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
<script>
  const socket = io('/sbr');
  const section = document.getElementById('sbr-config-section');
  const phases = ['influent','react','effluent','wait'];
  const boxes = {};
  const progressElems = {};
  const inputElems = {};
  const setBtns = {};

  // Setup element references and handlers
  phases.forEach(p => {
    boxes[p] = document.getElementById(`phase-${p}-box`);
    progressElems[p] = document.getElementById(`${p}-progress`);
    inputElems[p] = document.getElementById(`${p}-input`);
    setBtns[p] = document.querySelector(`.phase-set-btn[data-phase="${p}"]`);

    // Klik handler: stuur alle vier fasetijden tegelijk
    setBtns[p].addEventListener('click', () => {
      const infl = parseFloat(inputElems['influent'].value);
      const react = parseFloat(inputElems['react'].value);
      const effl = parseFloat(inputElems['effluent'].value);
      const wait = parseFloat(inputElems['wait'].value);
      if ([infl, react, effl, wait].some(v => isNaN(v) || v <= 0)) {
        return alert('Alle tijden moeten > 0 zijn');
      }
      socket.emit('sbr_set_phase_times', {
        influent: infl,
        react:    react,
        effluent: effl,
        wait:     wait
      });
    });

    // Enter-toets binding
    inputElems[p].addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        setBtns[p].click();
      }
    });
  });

  const btnToggle = document.getElementById('btn-toggle');
  const btnReset  = document.getElementById('btn-reset');

  // Initialiseer fase-tijden en status
  socket.on('connect', () => socket.emit('sbr_get_phase_times'));
  socket.on('sbr_phase_times', data => {
    phases.forEach(p => {
      // Toon voortgang op nul
      progressElems[p].textContent = `0 / ${data[p + '_seconds']} s`;
      // Vul input met huidige minuten
      inputElems[p].value = data[p + '_minutes'];
    });
  });

  // Update cycle-knop en pauze-status
  socket.on('sbr_status', data => {
    btnToggle.textContent = data.active ? 'Stop Cycle' : 'Start Cycle';
    section.classList.toggle('paused', !data.active);
  });

  btnToggle.addEventListener('click', () =>
    socket.emit('sbr_control', { action: 'toggle' })
  );
  btnReset.addEventListener('click', () =>
    socket.emit('sbr_control', { action: 'reset' })
  );

  // Update voortgang en highlight actieve fase
  socket.on('sbr_timer', data => {
    const { phase, phase_elapsed, phase_duration } = data;
    if (!phases.includes(phase)) return;
    progressElems[phase].textContent = `${phase_elapsed} / ${phase_duration} s`;
    phases.forEach(p =>
      boxes[p].classList.toggle('active', p === phase)
    );
  });
</script>
{% endblock %}
